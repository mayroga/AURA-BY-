import sqlite3
import random
import pandas as pd

DB_PATH = "aura_brain.db"

# ==============================
# 1️⃣ Crear DB y tablas
# ==============================
conn = sqlite3.connect(DB_PATH)
cursor = conn.cursor()

cursor.execute("""
CREATE TABLE IF NOT EXISTS prices (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    description TEXT,
    code TEXT,
    cash_price_low REAL,
    cash_price_high REAL,
    insured_price_low REAL,
    insured_price_high REAL,
    copay_low REAL,
    copay_high REAL,
    state TEXT,
    zip_code TEXT,
    county TEXT,
    provider_type TEXT
)
""")

conn.commit()

# ==============================
# 2️⃣ Población de datos educativos (~200 códigos)
# ==============================
estados = ["FL", "NY", "CA", "TX", "IL", "PA", "OH", "GA", "NC", "MI"]
counties = ["Miami-Dade", "New York", "Los Angeles", "Harris", "Cook", "Philadelphia", "Cuyahoga", "Fulton", "Mecklenburg", "Wayne"]
zip_codes = ["33160", "10001", "90001", "77001", "60601", "19101", "44101", "30301", "28201", "48201"]

# Procedimientos médicos y dentales (ejemplos educativos)
procedimientos = [
    ("Consulta médica general", "99213", "Médico"),
    ("Evaluación anual preventiva", "99396", "Médico"),
    ("Ecografía abdominal", "76700", "Médico"),
    ("Resonancia magnética (MRI)", "70551", "Médico"),
    ("Consulta especializada cardiología", "99243", "Médico"),
    ("Limpieza dental rutinaria", "D1110", "Dental"),
    ("Radiografía bitewing", "D0274", "Dental"),
    ("Empaste simple resina", "D2330", "Dental"),
    ("Extracción dental simple", "D7140", "Dental"),
    ("Endodoncia molar", "D3330", "Dental")
]

# Generar 200 filas combinando procedimientos + ubicación + rangos de mercado
datos = []
for _ in range(200):
    desc, code, prov_type = random.choice(procedimientos)
    state = random.choice(estados)
    county = random.choice(counties)
    zipc = random.choice(zip_codes)
    
    cash_low = random.randint(50, 500)
    cash_high = cash_low + random.randint(20, 200)
    insured_low = max(cash_low - random.randint(10, 50), 10)
    insured_high = max(cash_high - random.randint(10, 100), insured_low)
    copay_low = max(insured_low * 0.2, 5)
    copay_high = max(insured_high * 0.3, 10)
    
    datos.append((desc, code, cash_low, cash_high, insured_low, insured_high, copay_low, copay_high, state, zipc, county, prov_type))

cursor.executemany("""
INSERT INTO prices (
    description, code, cash_price_low, cash_price_high,
    insured_price_low, insured_price_high,
    copay_low, copay_high,
    state, zip_code, county, provider_type
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
""", datos)

conn.commit()

# ==============================
# 3️⃣ Función de “cerebro de estimado”
# ==============================
def estimado_cerebro(consulta, zip_user=None):
    df = pd.read_sql_query("SELECT * FROM prices", conn)
    term = consulta.lower()
    df_filtered = df[df['description'].str.lower().str.contains(term) | df['code'].str.contains(term)]
    
    resultado = {}

    # 3 más baratos locales
    if zip_user:
        local = df_filtered[df_filtered['zip_code'] == zip_user]
        resultado['local'] = local.nsmallest(3, 'cash_price_low')
    else:
        resultado['local'] = pd.DataFrame()

    # 3 más baratos por condado
    if zip_user:
        county_val = df_filtered[df_filtered['zip_code'] == zip_user]['county'].iloc[0] if not df_filtered[df_filtered['zip_code'] == zip_user].empty else None
        if county_val:
            county_df = df_filtered[df_filtered['county'] == county_val]
            resultado['county'] = county_df.nsmallest(3, 'cash_price_low')
        else:
            resultado['county'] = pd.DataFrame()
    else:
        resultado['county'] = pd.DataFrame()

    # 3 más baratos por estado
    if zip_user:
        state_val = df_filtered[df_filtered['zip_code'] == zip_user]['state'].iloc[0] if not df_filtered[df_filtered['zip_code'] == zip_user].empty else None
        if state_val:
            state_df = df_filtered[df_filtered['state'] == state_val]
            resultado['state'] = state_df.nsmallest(3, 'cash_price_low')
        else:
            resultado['state'] = pd.DataFrame()
    else:
        resultado['state'] = pd.DataFrame()

    # 5 más baratos nacionales
    resultado['national'] = df_filtered.nsmallest(5, 'cash_price_low')

    # Generar tablas listas para web
    tablas = {}
    for nivel, df_tab in resultado.items():
        if not df_tab.empty:
            tablas[nivel] = df_tab[['description','code','cash_price_low','cash_price_high','insured_price_low','insured_price_high','copay_low','copay_high','state','county','zip_code','provider_type']].to_dict(orient='records')
        else:
            tablas[nivel] = []

    return tablas

# ==============================
# 4️⃣ Prueba rápida
# ==============================
consulta_demo = "consulta"
zip_demo = "33160"
resultado_demo = estimado_cerebro(consulta_demo, zip_demo)
print("✅ Estimado generado con cerebro de mercado educativo")
print(resultado_demo)

conn.close()
